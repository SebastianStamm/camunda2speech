<script src="lib/hark.bundle.js"></script>
<script>
  navigator.mediaDevices.getUserMedia(
    // constraints - only audio needed for this app
    {
      audio: true
    })

    // Success callback
    .then(function (stream) {
      var options = { threshold: -50 };
      var speechEvents = hark(stream, options);
      var mediaRecorder = new MediaRecorder(stream);
      var chunks = [];
      mediaRecorder.ondataavailable = function (e) {
        chunks.push(e.data);
      }

      speechEvents.on('speaking', function () {
        console.log('start speaking');
        mediaRecorder.start();
      });

      speechEvents.on('stopped_speaking', function () {
        console.log('stop speaking');
        mediaRecorder.stop();
      });

      mediaRecorder.onstop = function (e) {
        var audio = document.createElement('audio');

        audio.setAttribute('controls', '');

        var blob = new Blob(chunks, { 'type': 'audio/wav' });
        chunks = [];
        var audioURL = window.URL.createObjectURL(blob);
        audio.src = audioURL;
        document.body.appendChild(audio);

        sendToServer(blob);
      }
    })

    // Error callback
    .catch(function (err) {
      console.log('The following getUserMedia error occured: ' + err);
    }
    );

  function sendToServer(blob) {
    fetch('http://192.168.80.143:8000/api/guess', {
      method: 'POST',
      body: blob,
      headers: { "Content-Type": "text/plain" }
    });
  }
</script>
